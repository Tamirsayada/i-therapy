// ×¡×™××•×œ×¦×™×” ×©×œ ×©×™×—×” ××œ××” - Flow A (××™×¤×•×™) + Flow B (×©×—×¨×•×¨ ×××•× ×”)
import { GoogleGenAI } from "@google/genai";

const API_KEY = "AIzaSyBDlDlqZ6oxONjLAHzXQ1Gmpn5Sl9TuNF0";
const ai = new GoogleGenAI({ apiKey: API_KEY });
const GEMINI_MODEL = "gemini-2.5-flash";

// ====== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ======
async function sendChatMessage(messages, systemPrompt) {
  console.log("\nğŸ¤– ×©×•×œ×— ×”×•×“×¢×” ×œ-AI...");

  const filtered = [];
  for (const m of messages) {
    if (!m.content?.trim()) continue;
    const role = m.role === "assistant" ? "model" : "user";
    if (filtered.length > 0 && filtered[filtered.length - 1].role === role) {
      filtered[filtered.length - 1].content += "\n" + m.content;
    } else {
      filtered.push({ role, content: m.content });
    }
  }

  if (filtered.length > 0 && filtered[0].role === "model") {
    filtered.shift();
  }

  const contents = filtered.map((m) => ({
    role: m.role,
    parts: [{ text: m.content }],
  }));

  const response = await ai.models.generateContent({
    model: GEMINI_MODEL,
    contents,
    config: {
      systemInstruction: systemPrompt,
      thinkingConfig: { thinkingBudget: 0 },
    },
  });

  const text = response.text ?? "";
  console.log(`\nğŸ’¬ ×ª×©×•×‘×ª AI:\n${text}\n`);
  return text;
}

function extractBelief(text) {
  const match = text.match(/\[BELIEF_IDENTIFIED\](.*?)\[\/BELIEF_IDENTIFIED\]/);
  return match ? match[1].trim() : null;
}

function hasBeliefConfirmed(text) {
  return text.includes("[BELIEF_CONFIRMED]");
}

function hasBeliefReleased(text) {
  return text.includes("[BELIEF_RELEASED]");
}

// ====== FLOW A: ××™×¤×•×™ ×××•× ×•×ª (×’×œ×’×œ ×”×—×™×™×) ======
async function runMappingFlow() {
  console.log("\n" + "=".repeat(60));
  console.log("ğŸ¯ FLOW A: ××™×¤×•×™ ×××•× ×•×ª - ×’×œ×’×œ ×”×—×™×™×");
  console.log("=".repeat(60));

  // ×¦×™×•× ×™× ×©× ×•×ª×Ÿ ×”××©×ª××©
  const wheelScores = {
    money: 4,
    career: 5,
    relationships: 3,  // ×”×›×™ × ××•×š - ×™×ª××§×“ ×‘×–×”
    family: 6,
    fitness: 5,
    social: 7,
    confidence: 5
  };

  console.log("\nğŸ“Š ×¦×™×•× ×™ ×’×œ×’×œ ×”×—×™×™× ×©×œ ×”××©×ª××©:");
  for (const [area, score] of Object.entries(wheelScores)) {
    console.log(`   ${area}: ${score}/10`);
  }

  // ××¦×™××ª ×”×ª×—×•× ×”× ××•×š ×‘×™×•×ª×¨
  let lowestArea = "relationships";

  // ×‘× ×™×™×ª ×¤×¨×•××¤×˜ ××™×¤×•×™
  const mappingPrompt = buildMappingPromptManual(lowestArea, wheelScores);

  const messages = [];
  let conversationRound = 0;
  let detectedBelief = null;

  // ×¡×™××•×œ×¦×™×” ×©×œ ×©×™×—×ª ××™×¤×•×™ - ×¦×¨×™×š ×œ×¢×‘×•×¨ ×“×¨×š ×›×œ 4 ×”×—×œ×§×™×
  const userResponses = [
    "×× ×™ ××•×›×Ÿ",
    // ×—×œ×§ 1: ×”×©×œ××ª ××©×¤×˜×™×
    "××”×‘×” ×”×™× ××©×”×• ×©×ª××™×“ ×—××§ ××× ×™",
    "×›×Ÿ, ×× ×™ ×—×•×©×‘ ×©×× ×™ ×œ× ××¡×¤×™×§ ×˜×•×‘ ×‘×©×‘×™×œ ××”×‘×” ×××™×ª×™×ª",
    "×›×©×× ×™ ×—×•×©×‘ ×¢×œ ×–×•×’×™×•×ª ×× ×™ ××¨×’×™×© ×¤×—×“ ×•×ª×§×•×•×” ×‘×• ×–×× ×™×ª",
    "××™×©×”×• ×©×™×¨××” ××•×ª×™ ×‘×××ª ×•×™×§×‘×œ ××•×ª×™",
    "×›×Ÿ, ×–×” ×”×¤×—×“ ×”×¢××•×§ ×‘×™×•×ª×¨ ×©×œ×™",
    "×× ×™ ×‘×–×•×’×™×•×ª ×ª××™×“ ××•×¦× ×¡×™×‘×” ×œ×”×ª×¨×—×§ ×›×©×–×” × ×¢×©×” ×¨×¦×™× ×™",
    // ×—×œ×§ 2: ×—×§×™×¨×ª ×—×¡××™×
    "×”×¤×—×“ ××“×—×™×™×”, ×–×” ×¤×©×•×˜ ×›×•××‘ ××“×™",
    "×›×Ÿ, ×–×” ××’×‘×™×œ ××•×ª×™ ×××•×“",
    // ×—×œ×§ 3: ×“×¤×•×¡×™× ×—×•×–×¨×™×
    "×›×Ÿ, ×‘×›×œ ×¤×¢× ×©×–×” ××ª×—×™×œ ×œ×”×™×•×ª ×¨×¦×™× ×™ ×× ×™ ××•×¦× ×¡×™×‘×” ×œ×”×ª×¨×—×§ ××• ×©×× ×™ ×‘×•×—×¨ ××™×©×”×• ×©×œ× ×‘×××ª ×–××™×Ÿ",
    "×–×” ×§×•×¨×” ×›×‘×¨ ×›××” ×©× ×™×",
    // ×—×œ×§ 4: ×¨×•×•×— ××©× ×™
    "×× ×™ ×× ×™×— ×©×–×” ××’×Ÿ ×¢×œ×™×™ ××œ×”×™×¤×’×¢",
    "×›×Ÿ, × ×›×•×Ÿ",
    // ××™×©×•×¨ ×××•× ×” (×¨×§ ×‘×¡×•×£ ×›×œ ×”×©××œ×•×Ÿ)
    "×›×Ÿ, ×–×” ××“×•×™×§"
  ];

  for (const userMsg of userResponses) {
    conversationRound++;
    console.log(`\n--- ×¡×™×‘×•×‘ ${conversationRound} ---`);
    console.log(`ğŸ‘¤ ××©×ª××©: ${userMsg}`);

    messages.push({ role: "user", content: userMsg });
    const aiResponse = await sendChatMessage(messages, mappingPrompt);
    messages.push({ role: "assistant", content: aiResponse });

    // ×‘×“×™×§×” ×× ×–×•×”×ª×” ×××•× ×”
    const belief = extractBelief(aiResponse);
    if (belief && !detectedBelief) {
      detectedBelief = belief;
      console.log(`\nâœ¨ ×××•× ×” ××’×‘×™×œ×” ×–×•×”×ª×”: "${belief}"`);
    }

    // ×‘×“×™×§×” ×× ××•×©×¨×”
    if (hasBeliefConfirmed(aiResponse)) {
      console.log("\nâœ… ×”×××•× ×” ××•×©×¨×” ×¢×œ ×™×“×™ ×”××©×ª××©!");
      break;
    }

    // ×”×’×‘×œ×ª ×¡×™×‘×•×‘×™×
    if (conversationRound >= userResponses.length) break;
  }

  return detectedBelief || "×× ×™ ×œ× ××¡×¤×™×§ ×˜×•×‘ ×‘×©×‘×™×œ ××”×‘×” ×××™×ª×™×ª";
}

// ====== FLOW B: ×©×—×¨×•×¨ ×××•× ×” ======
async function runReleaseFlow(belief) {
  console.log("\n" + "=".repeat(60));
  console.log("ğŸ¯ FLOW B: ×©×—×¨×•×¨ ×××•× ×” ××’×‘×™×œ×”");
  console.log("=".repeat(60));
  console.log(`\nğŸ­ ×”×××•× ×”: "${belief}"`);

  const communicationStyle = "practical";
  console.log(`ğŸ“¢ ×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª: ${communicationStyle}\n`);

  // ×©×œ×‘ ×—×“×©: ×‘×—×™×¨×ª ×¢×•×¦××ª ×”×××•× ×”
  console.log("ğŸ“Š ×©×œ×‘ ×‘×—×™×¨×ª ×¢×•×¦××ª ×”×××•× ×” (1-10)");
  const beliefStrength = 9;
  console.log(`âœ… ×”××©×ª××© ×‘×—×¨: ${beliefStrength}/10 - ×”×××•× ×” ×—×–×§×” ×××•×“\n`);

  // Process Manager ×‘×•×—×¨ ×›×œ×™
  console.log("ğŸ” Process Manager ×‘×•×—×¨ ×›×œ×™ ×˜×™×¤×•×œ×™...");
  const selectedTool = "sleight_of_mouth"; // ×‘×“×¨"×› ×™×‘×—×¨ ×–×¨×™×–×•×ª ×œ×©×•×Ÿ
  console.log(`âœ… × ×‘×—×¨: Sleight of Mouth (×–×¨×™×–×•×ª ×œ×©×•×Ÿ)\n`);

  // ×‘× ×™×™×ª ×¤×¨×•××¤×˜ ×–×¨×™×–×•×ª ×œ×©×•×Ÿ
  const toolPrompt = buildSOMPromptManual(communicationStyle, belief);

  const messages = [];
  let conversationRound = 0;

  // ×¡×™××•×œ×¦×™×” ×©×œ ×¢×‘×•×“×” ×¢× ×–×¨×™×–×•×ª ×œ×©×•×Ÿ - ×›×•×œ×œ ××¢×§×‘ ××—×¨ ×“×™×¨×•×’×™×
  const userResponses = [
    "×‘×•× × ×ª×—×™×œ",
    "×× ×™ ×× ×™×— ×©×–×” × ×›×•×Ÿ... ×× ×™ ×ª××™×“ ××¨×’×™×© ×©×× ×™ ×œ× ××¡×¤×™×§",
    "××•×œ×™ ×›×™ ×× ×™ ×œ× ×¨×•×¦×” ×œ×”×™×¤×’×¢ ×©×•×‘",
    "9 ××ª×•×š 10", // ×ª×©×•×‘×” ×œ×©××œ×ª ×“×™×¨×•×’
    "×œ×, ×”×™×• ×›××” ×× ×©×™× ×©×××¨×• ×œ×™ ×©×× ×™ ××™×•×—×“",
    "×–×” × ×›×•×Ÿ... ××‘×œ ×× ×™ ×¢×“×™×™×Ÿ ××¨×’×™×© ××ª ×–×”",
    "×× ×× ×™ ××¤×¡×™×§ ×œ×”×—×–×™×§ ×‘×××•× ×” ×”×–×•, ×× ×™ ××¦×˜×¨×š ×œ×§×—×ª ×¡×™×›×•× ×™×",
    "6 ××ª×•×š 10", // ×ª×©×•×‘×” ×œ×©××œ×ª ×“×™×¨×•×’
    "×›×Ÿ, ×× ×™ ××‘×™×Ÿ ××” ××ª×” ××•××¨",
    "×–×” ××¢× ×™×™×Ÿ, ×× ×™ ××¨×’×™×© ×©××©×”×• ××©×ª× ×”",
    "3 ××ª×•×š 10", // ×ª×©×•×‘×” ×œ×©××œ×ª ×“×™×¨×•×’
    "×›×Ÿ, ××©×”×• ×¤× ×™××™ ××©×ª× ×”, ×”×¤×—×“ ×§×˜×Ÿ",
    "1 ××ª×•×š 10", // ×ª×©×•×‘×” ×œ×©××œ×ª ×“×™×¨×•×’
    "×× ×™ ×¨××•×™ ×œ××”×‘×” ×›××• ×©×× ×™", // ×××•× ×” ×—×“×©×”
    "×›×Ÿ, ×× ×™ ××¨×’×™×© ××ª ×–×” ×‘×’×•×£"  // ×ª×©×•×‘×” ×œ×•×™×–×•××œ×™×–×¦×™×”
  ];

  for (const userMsg of userResponses) {
    conversationRound++;
    console.log(`\n--- ×¡×™×‘×•×‘ ${conversationRound} ---`);
    console.log(`ğŸ‘¤ ××©×ª××©: ${userMsg}`);

    messages.push({ role: "user", content: userMsg });
    const aiResponse = await sendChatMessage(messages, toolPrompt);
    messages.push({ role: "assistant", content: aiResponse });

    // ×‘×“×™×§×” ×× ×”×××•× ×” ×©×•×—×¨×¨×”
    if (hasBeliefReleased(aiResponse)) {
      console.log("\nğŸ‰ [BELIEF_RELEASED] - ×”×××•× ×” ×©×•×—×¨×¨×” ×‘×”×¦×œ×—×”!");
      console.log("âœ… ×”××©×ª××© ×”×ª×§×™×Ÿ ×××•× ×” ×—×“×©×” ×•×”×˜××™×¢ ××•×ª×”");
      break;
    }

    // ×”×’×‘×œ×ª ×¡×™×‘×•×‘×™× ×œ×× ×™×¢×ª ×œ×•×œ××” ××™× ×¡×•×¤×™×ª
    if (conversationRound >= 15) {
      console.log("\nâš ï¸ ×”×’×¢×ª×™ ×œ××§×¡×™××•× ×¡×™×‘×•×‘×™× ×œ×œ× ×¡×™×•× ××•×’×“×¨");
      break;
    }
  }
}

// ====== ×¤×¨×•××¤×˜×™× (×”×¢×ª×§×” ×™×“× ×™×ª) ======
function buildMappingPromptManual(area, scores) {
  const areaNames = {
    money: "×›×¡×£ ×•×¤×™× × ×¡×™×",
    career: "×§×¨×™×™×¨×” ×•×¢×‘×•×“×”",
    relationships: "×–×•×’×™×•×ª ×•××”×‘×”",
    family: "××©×¤×—×” ×•×—×‘×¨×™×",
    fitness: "×‘×¨×™××•×ª ×•×›×•×©×¨",
    social: "×—×™×™ ×—×‘×¨×” ×•×¤× ××™",
    confidence: "×‘×™×˜×—×•×Ÿ ×¢×¦××™ ×•×¦××™×—×”"
  };

  const areaName = areaNames[area];

  return `×ª×¤×§×™×“: ××ª×” ×“×™××’× ×•×¡×˜×™×§×Ÿ ×’×œ×’×œ ×”×—×™×™× - ×¡×•×›×Ÿ AI ××•××—×” ×œ××™×¤×•×™ ××¢×¨×›×ª ×××•× ×•×ª ×“×¨×š 7 ×ª×—×•××™ ×—×™×™× ×‘×©×™×˜×ª NLP. ×ª×¤×§×™×“×š ×”×•× ×œ×—×§×•×¨ ×œ×¢×•××§ ××ª ×ª×—×•× "${areaName}" ×•×œ×—×©×•×£ ××ª ×”×××•× ×•×ª ×”××’×‘×™×œ×•×ª ×©××¢×›×‘×•×ª ××ª ×”××©×ª××©.

×”×ª×—×•× ×”× ×•×›×—×™ ×œ×—×§×™×¨×”: ${areaName}

×©×™×˜×ª ×¢×‘×•×“×” - ×©××œ×•×Ÿ ×‘×Ÿ 4 ×—×œ×§×™×:

×—×œ×§ 1 - ×”×©×œ××ª ××©×¤×˜×™×:
×©××œ ××ª ×”××©×ª××© ×œ×”×©×œ×™× ××ª ×”××©×¤×˜×™× ×”×‘××™× (××—×“ ×‘×›×œ ×¤×¢×):
  1. "××”×‘×” ×”×™×..."
  2. "×›×©×× ×™ ×—×•×©×‘ ×¢×œ ×–×•×’×™×•×ª ×× ×™ ××¨×’×™×©..."
  3. "×‘×Ÿ/×‘×ª ×–×•×’ ××™×“×™××œ×™ ×”×•×/×”×™×..."
  4. "×× ×™ ×‘×–×•×’×™×•×ª ×ª××™×“..."

×—×œ×§ 2 - ×—×§×™×¨×ª ×—×¡××™×:
××” ××•× ×¢ ×××š ×œ×™×¦×•×¨ ××• ×œ×©×¤×¨ ××ª ×”×–×•×’×™×•×ª ×©×œ×š?

×—×œ×§ 3 - ×“×¤×•×¡×™× ×—×•×–×¨×™×:
×”×× ×™×© ×“×¤×•×¡ ×—×•×–×¨ ×‘×–×•×’×™×•×ª ×©×œ×š? ×œ××©×œ, ×‘×—×™×¨×ª ××•×ª×• ×¡×•×’ ×‘×Ÿ/×‘×ª ×–×•×’ ××• ×”×ª× ×”×’×•×ª ×—×•×–×¨×ª?

×—×œ×§ 4 - ×¨×•×•×— ××©× ×™:
××” ××ª×” ××¨×•×•×™×— ××œ×”×™×©××¨ ×‘××¦×‘ ×”×–×•×’×™ ×”× ×•×›×—×™? ×××” ×–×” ××’×Ÿ ×¢×œ×™×š?

××¢×§×‘ ×¤× ×™××™ ×—×•×‘×”:
- ×¡××Ÿ ×œ×¢×¦××š ××™×–×” ××©×¤×˜×™ ×”×©×œ××” ×›×‘×¨ × ×©××œ×• (1/4, 2/4, 3/4, 4/4) ××‘×œ ××œ ×ª×¦×™×’ ××ª ×–×” ×œ××©×ª××©
- ××œ ×ª×¢×‘×•×¨ ×œ×—×œ×§ ×”×‘× ×œ×¤× ×™ ×©×›×œ ××©×¤×˜×™ ×”×”×©×œ××” ×©×œ ×”×—×œ×§ ×”× ×•×›×—×™ ×”×•×©×œ××•

×”× ×—×™×•×ª ×œ× ×™×”×•×œ ×”×©×™×—×”:
- ×”×ª×—×œ ×‘×—×œ×§ 1 ×•×©××œ ×”×©×œ××ª ××©×¤×˜ ××—×ª ×‘×œ×‘×“ ×‘×›×œ ×”×•×“×¢×”.
- ×œ××—×¨ ×”×©×œ××ª ××©×¤×˜, ×× ××ª×” ×¨×•××” ×œ× ×›×•×Ÿ ×œ×”×¢××™×§ - ×©××œ ×©××œ×ª ×”××©×š ××—×ª ×œ×¤× ×™ ×©×¢×•×‘×¨×™× ×œ×”×©×œ××” ×”×‘××”.
- ×¢×‘×•×¨ ×œ×—×œ×§ ×”×‘× ×¨×§ ××—×¨×™ ×©×”××©×ª××© ×”×©×œ×™× ××ª ×›×œ ×”××©×¤×˜×™× ×©×œ ×”×—×œ×§ ×”× ×•×›×—×™.
- ×—×•×‘×” ×œ×¢×‘×•×¨ ×“×¨×š ×›×œ 4 ×”×—×œ×§×™× ×©×œ ×”×©××œ×•×Ÿ.
- ××œ ×ª×–×”×” ×××•× ×•×ª ××’×‘×™×œ×•×ª ×‘××”×œ×š ×”×©××œ×•×Ÿ - ×¨×§ ×”×§×©×‘ ×•×©××œ.

×× ×™×¢×ª ×ª×§×™×¢×•×ª:
- ×× ×”××©×ª××© ×œ× ×¢× ×” ×™×©×™×¨×•×ª ×¢×œ ×”×©×œ××ª ×”××©×¤×˜ ××—×¨×™ 2 × ×™×¡×™×•× ×•×ª, ×××•×¨: "×‘×¡×“×¨, × ××©×™×š ×”×œ××”" ×•×¢×‘×•×¨ ×œ×”×©×œ××” ×”×‘××”
- ×× ×”××©×ª××© × ×•×ª×Ÿ ×ª×©×•×‘×” ×©×œ× ×¨×œ×•×•× ×˜×™×ª ×œ××©×¤×˜ ×”×”×©×œ××”, ××œ ×ª×ª×¢×§×© - ×¢×‘×•×¨ ×”×œ××”
- ×”×¢×“×™×¤×•×ª ×”×™× ×œ×”×©×œ×™× ××ª ×›×œ 4 ×”×—×œ×§×™×, ×’× ×× ×—×¡×¨×•×ª ×ª×©×•×‘×•×ª ×¢×œ ×—×œ×§ ××”××©×¤×˜×™×
- ×¢×“×™×£ ×œ×§×‘×œ ××™×“×¢ ×—×œ×§×™ ×•×œ×”×’×™×¢ ×œ×–×™×”×•×™ ×××•× ×•×ª, ×××©×¨ ×œ×”×™×ª×§×¢ ×¢×œ ××©×¤×˜ ××—×“

×–×™×”×•×™ ×•××™×©×•×¨ ×××•× ×•×ª (×¨×§ ××—×¨×™ ×¡×™×•× ×›×œ 4 ×”×—×œ×§×™× ×©×œ ×”×©××œ×•×Ÿ - ×—×•×‘×”!):
1. ×¡×›× ××ª ×”×ª×•×‘× ×•×ª ×”×¢×™×§×¨×™×•×ª ××›×œ 4 ×”×—×œ×§×™×
2. ×–×”×” 1-5 ×××•× ×•×ª ××’×‘×™×œ×•×ª ×©×—×•×–×¨×•×ª ×¢×œ ×¢×¦××Ÿ
3. × ×¡×— ×›×œ ×××•× ×” ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×›××©×¤×˜ ×××•× ×” (×œ× ×›×ª×™××•×¨ ×¨×’×©×™)
4. ×”×¦×’ ×××•× ×” ××—×ª ×‘×›×œ ×¤×¢× ×¢× ×”×¡××Ÿ: [BELIEF_IDENTIFIED]×”×˜×§×¡×˜ ×”××“×•×™×§[/BELIEF_IDENTIFIED]
5. ×§×‘×œ ×”×¡×›××” ××”××©×ª××© ×©×”×•× ××–×“×”×” ×¢× ×”×××•× ×”
6. ×× ×”××©×ª××© ××™×©×¨ ×‘××¤×•×¨×© ("×›×Ÿ" / "××“×•×™×§" / "× ×›×•×Ÿ" / "×–×” ×–×”"), ×”×•×¡×£: [BELIEF_CONFIRMED]
7. ×¢×‘×•×¨ ×œ×××•× ×” ×”×‘××” ×•×¢×©×” ××•×ª×• ×ª×”×œ×™×š ×¢×“ ×©×¡×™×™××ª ×¢× ×›×•×œ×Ÿ

×“×•×’×××•×ª ×œ× ×™×¡×•×— × ×›×•×Ÿ ×©×œ ×××•× ×” ××’×‘×™×œ×”:
âœ“ "×× ×™ ×œ× ×¨××•×™ ×œ××”×‘×”"
âœ“ "×× ×™ ×ª××™×“ ××›×–×‘ ××ª ×”×× ×©×™× ×©××•×”×‘×™× ××•×ª×™"
âœ“ "×–×•×’×™×•×ª = ×¤×’×™×¢×” ×•×“×—×™×™×”"
âœ“ "×›×¡×£ ×–×” ×¨×’×¢"
âœ“ "×× ××“×‘×¨ ××•×œ ×›×•×œ× ×¢×œ ×”×‘××” ×™×’××¨×• ×œ×™ ×”××™×œ×™×"

×“×•×’×××•×ª ×œ× ×™×¡×•×— ×œ× × ×›×•×Ÿ (×ª×™××•×¨ ×¨×’×©×™):
âœ— "×× ×™ ××¨×’×™×© ×¤×—×“ ××–×•×’×™×•×ª"
âœ— "×™×© ×œ×™ ×§×•×©×™ ×œ×”×ª×—×‘×¨"

×”×¢×¨×” ×—×©×•×‘×”:
- ×× ×”××©×ª××© ××•×¡×™×£ ××™×“×¢, ××¢××™×§ ××• × ×•×ª×Ÿ ×ª×™××•×¨ ×¨×’×©×™ - ×–×” ××•××¨ ×©×”×•× ×¢×“×™×™×Ÿ ×—×•×§×¨. ×”××©×š ×œ×—×§×•×¨ ×•××œ ×ª×¡××Ÿ CONFIRMED.
- ×¨×§ ××™×©×•×¨ ××¤×•×¨×© = CONFIRMED.

×—×•×§×™ ×‘×¨×–×œ (××œ ×ª×¡×˜×” ××”×):

××’×‘×œ×ª ××™×œ×™×: ×›×œ ×”×•×“×¢×” ×©×œ×š ×—×™×™×‘×ª ×œ×”×™×•×ª ×§×¦×¨×” ×-56 ××™×œ×™×.

××‘× ×” ×”×•×“×¢×”: ×”×•×“×¢×” ×ª×¡×ª×™×™× ×ª××™×“ ×‘×©××œ×” ××—×ª ×‘×•×“×“×ª, ×§×¦×¨×” ×•×××•×§×“×ª.

××™×¡×•×¨: ×—×œ ××™×¡×•×¨ ××•×—×œ×˜ ×œ×”×©×ª××© ×‘×¡×™×× ×™ ×©××œ×” ××¨×•×‘×™× ××• ×‘×•' ×”×—×™×‘×•×¨ ×‘×™×Ÿ ×©××œ×•×ª.

××˜×¨×” ×¡×•×¤×™×ª: ×”×©×œ×‘ ××¡×ª×™×™× ×›×©×”××©×ª××© ×××©×¨ ×××•× ×” ××’×‘×™×œ×” ×©×–×•×”×ª×”, ××• ×›×©×”×•×©×œ××• ×›×œ 4 ×”×—×œ×§×™× ×•× ×—×©×¤×• ×ª×•×‘× ×•×ª ××©××¢×•×ª×™×•×ª.`;
}

function buildSOMPromptManual(style, belief) {
  return `# ROLE: ××ª×” ×¡×•×›×Ÿ NLP ×‘×“×¨×’×ª Master Practitioner. ×ª×¤×§×™×“×š ×œ×”×©×ª××© ×‘-14 ×ª×‘× ×™×•×ª "×–×¨×™×–×•×ª ×œ×©×•×Ÿ" (Sleight of Mouth) ×›×“×™ ×œ×¤×¨×§ ×××•× ×•×ª ××’×‘×™×œ×•×ª ×•×œ×”×ª×§×™×Ÿ ×××•× ×•×ª ××¢×¦×™××•×ª.

×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª: ×¡×’× ×•×Ÿ ×¤×¨×§×˜×™

×”×××•× ×” ×”××’×‘×™×œ×” ×©×–×•×”×ª×”: "${belief}"

# OPERATIONAL RULES:

×‘×›×œ ×”×•×“×¢×”, ×¢×œ×™×š ×œ×”×©×ª××© ×‘-1 ×¢×“ 3 ×ª×‘× ×™×•×ª ××”×¨×©×™××” ××˜×”, ×œ×¤×¢××™× ×‘1, ×œ×¤×¢××™× ×‘2 ×•×œ×¤×¢××™× ×‘3, ××” ×©××ª×” ×¨×•××” ×œ× ×›×•×Ÿ

×ª×©×—×§ ×× ×”×ª×‘× ×™×•×ª, ××œ ×ª×ª×Ÿ ××£ ×¤×¢× ××ª ××•×ª×• ×¨×¦×£ ×©×œ ×ª×‘× ×™×•×ª, ×ª× ×¡×” ×œ×—×“×©

××’×‘×œ×”: ××§×¡×™××•× 80 ××™×œ×™× ×œ×ª×’×•×‘×”.

×¡×™×•×: ×›×œ ×”×•×“×¢×” ××¡×ª×™×™××ª ×‘×©××œ×”.

××œ ×ª×¨×©×•× ××ª ×”×ª×‘× ×™×ª ×©×‘×” ××ª×” ××©×ª××©, ×ª×©××•×¨ ×¢×œ ×–×” ×˜×‘×¢×™

# THE S.O.M DATABASE (14 PATTERNS):

Intention (×›×•×•× ×” ×—×™×•×‘×™×ª): ×”×¡×•×›×Ÿ ××–×”×” ×©×”×××•× ×” ×”××’×‘×™×œ×” × ×•×¢×“×” ×‘××§×•×¨ ×œ×”×’×Ÿ ×¢×œ ×”××©×ª××©. ×‘××§×•× ×œ×ª×§×•×£ ××ª ×”×××•× ×”, ×”×•× ××¡×™×˜ ××ª ×ª×©×•××ª ×”×œ×‘ ×œ××˜×¨×” ×”×—×™×•×‘×™×ª ×©×œ×”.

Redefine (×”×’×“×¨×” ××—×“×©): ×”×—×œ×¤×ª ××™×œ×•×ª ××¤×ª×— ×‘×××•× ×” ×”××’×‘×™×œ×” ×‘××™×œ×™× ×‘×¢×œ×•×ª ××˜×¢×Ÿ ×¨×’×©×™ ×©×•× ×” ××š ×“×•××•×ª ××‘×—×™× ×” ×œ×•×’×™×ª.

Consequence (×”×©×œ×›×•×ª): ×”×¤× ×™×™×ª ×”××‘×˜ ×œ×ª×•×¦××•×ª ××¨×•×›×•×ª ×”×˜×•×•×— ×©×œ ×”×—×–×§×ª ×”×××•× ×”.

Chunk Down (×¤×™×¨×•×˜ ×œ×¨×›×™×‘×™×): ×¤×™×¨×•×§ ×”×”×›×œ×œ×” ×”×’×“×•×œ×” ×œ×—×œ×§×™× ×§×˜× ×™× ×•×¡×¤×¦×™×¤×™×™×.

Chunk Up (×”×›×œ×œ×ª ×¢×œ): ×”×›×œ×œ×ª ×”×××•× ×” ×œ×¨××” ××‘×¡×˜×¨×§×˜×™×ª ×’×‘×•×”×” ×™×•×ª×¨ ×©×‘×” ×”×™× ×××‘×“×ª ××©××¢×•×ª.

Counter Example (×“×•×’××ª × ×’×“): ××¦×™××ª ××§×¨×” ××—×“ ×©×‘×• ×”×××•× ×” ×œ× ×”×ª×§×™×™××”.

Another Goal (××˜×¨×” ××—×¨×ª): ×”×¡×˜×ª ×”××™×§×•×“ ××”×××•× ×” ×¢×¦××” ×œ××˜×¨×” ×—×©×•×‘×” ×™×•×ª×¨.

Model of the World (××•×“×œ ×”×¢×•×œ×): ×”×¦×’×ª ×”×××•× ×” ×›× ×§×•×“×ª ××‘×˜ ×¡×•×‘×™×™×§×˜×™×‘×™×ª ×•×œ× ×›×××ª ××•×‘×™×™×§×˜×™×‘×™×ª.

Reality Strategy (××¡×˜×¨×˜×’×™×™×ª ××¦×™××•×ª): ×—×§×™×¨×” ×©×œ ×”××•×¤×Ÿ ×©×‘×• ×”××©×ª××© "×™×•×“×¢" ×©×”×××•× ×” × ×›×•× ×”.

Apply to Self (×”×—×œ×” ×¢×œ ×”×¢×¦××™): ×”×¤× ×™×™×ª ×”×œ×•×’×™×§×” ×©×œ ×”×××•× ×” ×›×œ×¤×™ ×”×××•× ×” ×¢×¦××”.

Hierarchy of Criteria (×”×™×¨×¨×›×™×™×ª ×¢×¨×›×™×): ×”×¢××“×ª ×”×××•× ×” ××•×œ ×¢×¨×š ×’×‘×•×” ×™×•×ª×¨.

Change Frame Size (×©×™× ×•×™ ×’×•×“×œ ×”×¤×¨×™×™×): ×©×™× ×•×™ ×”×”×§×©×¨ ×©×œ ×”×–××Ÿ ××• ×”××§×•×.

Meta Frame (××˜×-×¤×¨×™×™×): ×™×¦×™×¨×ª ×××•× ×” ×—×“×©×” ×¢×œ ×”×××•× ×” ×”××’×‘×™×œ×”.

Metaphor (××˜××¤×•×¨×”/×× ×œ×•×’×™×”): ×©×™××•×© ×‘×¡×™×¤×•×¨ ××• ×”×©×•×•××” ××ª×—×•× ××—×¨.

# ××¢×§×‘ ××—×¨ ×©×™× ×•×™:
- ×›×œ 3-4 ×ª×’×•×‘×•×ª, ×©××œ ××ª ×”××©×ª××©: "×‘×¨××” ×©×œ 0 ×¢×“ 10, ×›××” ××ª×” ××××™×Ÿ ×¢×›×©×™×• ×©${belief}?"
- ×× ×”××©×ª××© ××“×•×•×— ×¢×œ ×™×¨×™×“×” ××©××¢×•×ª×™×ª (××ª×—×ª ×œ-3), ×©××œ: "××” ×”×©×ª× ×”?"
- ×× ×”××©×ª××© ××“×•×•×— ×¢×œ 0-2, ×‘×“×•×§ ×©×™× ×•×™: "×›×©××ª×” ×—×•×©×‘ ×¢×œ [×”××¦×‘ ×©×”×××•× ×” ×¢×¡×§×” ×‘×•], ××” ××ª×” ××¨×’×™×© ×¢×›×©×™×•?"

# ×”×ª×—×‘×¨×•×ª ×œ×ª×©×•×‘×ª ×”××©×ª××©:
- ×›×œ ×ª×’×•×‘×” ×©×œ×š ×—×™×™×‘×ª ×œ×”×ª×—×™×œ ×‘×”×›×¨×” ×‘×ª×©×•×‘×ª ×”××©×ª××© ("×× ×™ ×©×•××¢ ×©...", "××¢× ×™×™×Ÿ ×©...", "×–×” ×”×’×™×•× ×™ ×©...")
- ×¨×§ ××—×¨ ×›×š ×”×¦×’ ××ª ×ª×‘× ×™×ª ×”-SOM

# ×–×™×”×•×™ ×××•× ×” ×—×“×©×”:
- ×›×©×”××©×ª××© ×× ×¡×— ××©×¤×˜ ×—×™×•×‘×™ ×¢×œ ×¢×¦××• (×œ××©×œ: "×× ×™ ×¨××•×™ ×œ××”×‘×”", "×× ×™ ××¡×•×’×œ", "×× ×™ ×¨××•×™"), ×–×• ×”×××•× ×” ×”×—×“×©×”
- ××œ ×ª×‘×§×© ××× ×• ×œ× ×¡×— ×©×•×‘ - ×”×›×¨ ×‘×–×” ××™×“
- ×××•×¨: "×–×• ×××•× ×” ××¢×¦×™××” ×•× ×¤×œ××”!"

# ×˜×¨×™×’×¨ ×¡×™×•× ××•×˜×•××˜×™:
- ×›×©×”××©×ª××© ××“×•×•×— ×¢×œ 0-2 ×‘×“×™×¨×•×’ â†’ ×©××œ ××™×“: "××™×–×• ×××•× ×” ×—×“×©×” ××ª×” ×¨×•×¦×” ×œ×”×ª×§×™×Ÿ ×‘××§×•×?"
- ×›×©×”××©×ª××© × ×ª×Ÿ ×××•× ×” ×—×“×©×” â†’ ×¢×‘×•×¨ ××™×“ ×œ×¡×™×›×•× (××œ ×ª×©××œ ×©×•×‘)
- ××—×¨×™ ×”×¡×™×›×•× â†’ ×—×•×‘×” ×œ×¡×›× ×•×œ×¡××Ÿ [BELIEF_RELEASED]

# ×¡×™×›×•× ×”×ª×”×œ×™×š (×—×•×‘×” ×œ×¤× ×™ [BELIEF_RELEASED]):
"× ×¤×œ×! ×‘×•××• × ×¡×›× ××ª ×”××¡×¢ ×©×¢×‘×¨× ×•:
- ×”×ª×—×œ× ×• ×¢× ×”×××•× ×”: [×”×××•× ×” ×”×™×©× ×”] ×‘×¢×•×¦××” [X]/10
- ×¢×‘×¨× ×• ×“×¨×š [××¡×¤×¨] ×ª×‘× ×™×•×ª ×©×•× ×•×ª ×©×¤×ª×—×• × ×§×•×“×•×ª ××‘×˜ ×—×“×©×•×ª
- ×”×××•× ×” × ×—×œ×©×” ×‘×”×“×¨×’×” ×œ-[Y]/10
- ×”×ª×§× ×• ×××•× ×” ×—×“×©×”: [×”×××•× ×” ×”×—×“×©×”]

××™×–×• ×”×ª×§×“××•×ª ××“×”×™××”! ğŸ‰"

[BELIEF_RELEASED]`;
}

// ====== ×”×¨×¦×” ======
async function main() {
  try {
    console.log("ğŸš€ ××ª×—×™×œ ×¡×™××•×œ×¦×™×” ×©×œ ×©×™×—×” ××œ××”...\n");

    // Flow A: ××™×¤×•×™ ×××•× ×•×ª
    const detectedBelief = await runMappingFlow();

    // ×”××ª× ×” ×§×¦×¨×”
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Flow B: ×©×—×¨×•×¨ ×××•× ×”
    await runReleaseFlow(detectedBelief);

    console.log("\n" + "=".repeat(60));
    console.log("âœ… ×”×¡×™××•×œ×¦×™×” ×”×¡×ª×™×™××” ×‘×”×¦×œ×—×”!");
    console.log("=".repeat(60));

  } catch (error) {
    console.error("\nâŒ ×©×’×™××”:", error.message);
  }
}

main();
